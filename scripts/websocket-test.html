<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventory WebSocket Test</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #00d9ff;
      margin-bottom: 20px;
    }
    .status-bar {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 15px;
      background: #16213e;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ff4444;
    }
    .status-dot.connected {
      background: #44ff44;
      box-shadow: 0 0 10px #44ff44;
    }
    .status-dot.connecting {
      background: #ffaa00;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    input, button, select {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
    }
    input {
      background: #0f3460;
      color: #fff;
      min-width: 300px;
    }
    button {
      background: #00d9ff;
      color: #1a1a2e;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    button:hover {
      background: #00b8d4;
      transform: translateY(-1px);
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
    }
    button.danger {
      background: #ff4444;
      color: white;
    }
    button.danger:hover {
      background: #cc3333;
    }
    select {
      background: #0f3460;
      color: #fff;
    }
    .panels {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    @media (max-width: 900px) {
      .panels {
        grid-template-columns: 1fr;
      }
    }
    .panel {
      background: #16213e;
      border-radius: 8px;
      overflow: hidden;
    }
    .panel-header {
      background: #0f3460;
      padding: 12px 15px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .panel-content {
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }
    .message {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      word-break: break-all;
    }
    .message.received {
      background: #1a4d1a;
      border-left: 3px solid #44ff44;
    }
    .message.sent {
      background: #1a1a4d;
      border-left: 3px solid #4444ff;
    }
    .message.error {
      background: #4d1a1a;
      border-left: 3px solid #ff4444;
    }
    .message.info {
      background: #1a3d4d;
      border-left: 3px solid #00d9ff;
    }
    .message-time {
      color: #888;
      font-size: 10px;
      margin-bottom: 5px;
    }
    .message-type {
      color: #00d9ff;
      font-weight: bold;
    }
    .subscribe-section {
      margin-top: 20px;
    }
    .channel-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .channel-tag {
      background: #0f3460;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .channel-tag button {
      background: transparent;
      color: #ff4444;
      padding: 2px 6px;
      font-size: 12px;
    }
    .test-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .test-buttons button {
      background: #e94560;
    }
    .test-buttons button:hover {
      background: #c73e54;
    }
    pre {
      background: #0a0a15;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .clear-btn {
      background: transparent;
      color: #888;
      font-size: 12px;
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Inventory WebSocket Test</h1>

    <div class="status-bar">
      <div class="status-indicator">
        <div id="statusDot" class="status-dot"></div>
        <span id="statusText">Disconnected</span>
      </div>
      <div class="controls">
        <input type="text" id="wsUrl" value="ws://localhost:8792/ws" placeholder="WebSocket URL">
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled class="danger">Disconnect</button>
      </div>
    </div>

    <div class="subscribe-section">
      <div class="controls">
        <select id="channelType">
          <option value="global">Global (all events)</option>
          <option value="product">Product Channel</option>
          <option value="warehouse">Warehouse Channel</option>
          <option value="variant">Variant Channel</option>
        </select>
        <input type="text" id="channelId" placeholder="Channel ID (for product/warehouse/variant)" style="min-width: 200px;">
        <button onclick="subscribe()" id="subscribeBtn" disabled>Subscribe</button>
      </div>
      <div class="channel-tags" id="channelTags"></div>
    </div>

    <div class="test-buttons">
      <button onclick="sendPing()" id="pingBtn" disabled>Send Ping</button>
      <button onclick="simulateInventoryUpdate()" id="testBtn" disabled>Simulate Inventory Update</button>
      <button onclick="simulateLowStock()" id="lowStockBtn" disabled>Simulate Low Stock Alert</button>
    </div>

    <div class="panels">
      <div class="panel">
        <div class="panel-header">
          <span>Messages Received</span>
          <button class="clear-btn" onclick="clearMessages('received')">Clear</button>
        </div>
        <div class="panel-content" id="receivedMessages"></div>
      </div>
      <div class="panel">
        <div class="panel-header">
          <span>Messages Sent</span>
          <button class="clear-btn" onclick="clearMessages('sent')">Clear</button>
        </div>
        <div class="panel-content" id="sentMessages"></div>
      </div>
    </div>
  </div>

  <script>
    let ws = null;
    let subscribedChannels = new Set();

    function log(container, type, content, messageType = '') {
      const el = document.getElementById(container);
      const msg = document.createElement('div');
      msg.className = `message ${type}`;

      const time = new Date().toLocaleTimeString();
      let html = `<div class="message-time">${time}</div>`;

      if (messageType) {
        html += `<div class="message-type">${messageType}</div>`;
      }

      if (typeof content === 'object') {
        html += `<pre>${JSON.stringify(content, null, 2)}</pre>`;
      } else {
        html += `<div>${content}</div>`;
      }

      msg.innerHTML = html;
      el.insertBefore(msg, el.firstChild);
    }

    function updateStatus(status) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      const connectBtn = document.getElementById('connectBtn');
      const disconnectBtn = document.getElementById('disconnectBtn');
      const subscribeBtn = document.getElementById('subscribeBtn');
      const pingBtn = document.getElementById('pingBtn');
      const testBtn = document.getElementById('testBtn');
      const lowStockBtn = document.getElementById('lowStockBtn');

      dot.className = 'status-dot ' + status;
      text.textContent = status.charAt(0).toUpperCase() + status.slice(1);

      const isConnected = status === 'connected';
      connectBtn.disabled = isConnected;
      disconnectBtn.disabled = !isConnected;
      subscribeBtn.disabled = !isConnected;
      pingBtn.disabled = !isConnected;
      testBtn.disabled = !isConnected;
      lowStockBtn.disabled = !isConnected;
    }

    function connect() {
      const url = document.getElementById('wsUrl').value;
      updateStatus('connecting');
      log('receivedMessages', 'info', `Connecting to ${url}...`);

      try {
        ws = new WebSocket(url);

        ws.onopen = () => {
          updateStatus('connected');
          log('receivedMessages', 'info', 'Connected successfully!');
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            log('receivedMessages', 'received', data, data.type || 'message');
          } catch {
            log('receivedMessages', 'received', event.data);
          }
        };

        ws.onerror = (error) => {
          log('receivedMessages', 'error', 'WebSocket error occurred');
          console.error('WebSocket error:', error);
        };

        ws.onclose = (event) => {
          updateStatus('disconnected');
          log('receivedMessages', 'info', `Disconnected (code: ${event.code})`);
          ws = null;
          subscribedChannels.clear();
          updateChannelTags();
        };
      } catch (error) {
        updateStatus('disconnected');
        log('receivedMessages', 'error', `Failed to connect: ${error.message}`);
      }
    }

    function disconnect() {
      if (ws) {
        ws.close();
      }
    }

    function send(data) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        const message = typeof data === 'string' ? data : JSON.stringify(data);
        ws.send(message);
        log('sentMessages', 'sent', data, data.type || 'message');
      }
    }

    function subscribe() {
      const type = document.getElementById('channelType').value;
      const id = document.getElementById('channelId').value;

      let channel;
      if (type === 'global') {
        channel = 'global';
      } else if (id) {
        channel = `${type}:${id}`;
      } else {
        alert(`Please enter a ${type} ID`);
        return;
      }

      send({
        type: 'subscribe',
        channel: channel
      });

      subscribedChannels.add(channel);
      updateChannelTags();
      document.getElementById('channelId').value = '';
    }

    function unsubscribe(channel) {
      send({
        type: 'unsubscribe',
        channel: channel
      });

      subscribedChannels.delete(channel);
      updateChannelTags();
    }

    function updateChannelTags() {
      const container = document.getElementById('channelTags');
      container.innerHTML = '';

      subscribedChannels.forEach(channel => {
        const tag = document.createElement('div');
        tag.className = 'channel-tag';
        tag.innerHTML = `
          <span>${channel}</span>
          <button onclick="unsubscribe('${channel}')">x</button>
        `;
        container.appendChild(tag);
      });
    }

    function sendPing() {
      send({ type: 'ping', timestamp: Date.now() });
    }

    function simulateInventoryUpdate() {
      // This sends a test message to the server
      // In a real scenario, inventory updates would come from the server
      send({
        type: 'test_event',
        event: {
          type: 'inventory.updated',
          data: {
            inventoryId: 'test-inv-' + Date.now(),
            productId: 'prod-001',
            warehouseId: 'wh-jkt-01',
            previousQuantity: 100,
            newQuantity: 95,
            change: -5,
            movementType: 'out',
            timestamp: new Date().toISOString()
          }
        }
      });
    }

    function simulateLowStock() {
      send({
        type: 'test_event',
        event: {
          type: 'inventory.low_stock',
          data: {
            inventoryId: 'test-inv-' + Date.now(),
            productId: 'prod-001',
            warehouseId: 'wh-jkt-01',
            currentQuantity: 5,
            minimumStock: 10,
            timestamp: new Date().toISOString()
          }
        }
      });
    }

    function clearMessages(type) {
      document.getElementById(type + 'Messages').innerHTML = '';
    }

    // Update channel ID input visibility based on channel type
    document.getElementById('channelType').addEventListener('change', (e) => {
      const channelId = document.getElementById('channelId');
      channelId.style.display = e.target.value === 'global' ? 'none' : 'block';
    });
  </script>
</body>
</html>
