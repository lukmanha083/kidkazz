name: Security Auto-Fix

on:
  # Trigger when Dependabot alerts are created
  dependabot_alert:
    types: [created]

  # Also run on schedule to catch any missed alerts
  schedule:
    - cron: '0 8 * * *'  # Daily at 8 AM UTC (3 PM WIB)

  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: read

jobs:
  auto-fix-vulnerabilities:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Get vulnerable packages
        id: vulns
        run: |
          # Get list of vulnerable packages from Dependabot alerts
          VULNS=$(gh api /repos/${{ github.repository }}/dependabot/alerts \
            --jq '[.[] | select(.state == "open") | .dependency.package.name] | unique | join(" ")' || echo "")

          echo "packages=$VULNS" >> $GITHUB_OUTPUT

          if [ -z "$VULNS" ]; then
            echo "No open vulnerabilities found"
            echo "has_vulns=false" >> $GITHUB_OUTPUT
          else
            echo "Found vulnerable packages: $VULNS"
            echo "has_vulns=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update vulnerable packages
        if: steps.vulns.outputs.has_vulns == 'true'
        run: |
          echo "Updating vulnerable packages: ${{ steps.vulns.outputs.packages }}"

          for pkg in ${{ steps.vulns.outputs.packages }}; do
            echo "Updating $pkg..."
            pnpm update "$pkg" -r || echo "Failed to update $pkg directly"
          done

          # Also run general update to catch transitive dependencies
          pnpm update -r

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        run: |
          # Configure git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Create branch
          BRANCH="security/auto-fix-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"

          # Commit changes
          git add -A
          git commit -m "chore(deps): auto-fix security vulnerabilities

          Automatically updated packages with known vulnerabilities:
          ${{ steps.vulns.outputs.packages }}

          Triggered by: ${{ github.event_name }}"

          # Push branch
          git push -u origin "$BRANCH"

          # Create PR
          gh pr create \
            --title "ðŸ”’ Security: Auto-fix vulnerable dependencies" \
            --body "$(cat <<EOF
          ## Security Auto-Fix

          This PR was automatically created to fix security vulnerabilities detected by Dependabot.

          ### Updated Packages
          \`\`\`
          ${{ steps.vulns.outputs.packages }}
          \`\`\`

          ### Trigger
          - Event: \`${{ github.event_name }}\`
          - Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### Review Checklist
          - [ ] Verify updated packages don't break functionality
          - [ ] Run tests locally if needed
          - [ ] Check for any breaking changes in updated packages

          ---
          ðŸ¤– Generated by Security Auto-Fix workflow
          EOF
          )" \
            --label "security,dependencies"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge if tests pass
        if: steps.changes.outputs.changed == 'true'
        run: |
          # Get the PR number
          PR_NUMBER=$(gh pr list --head "security/auto-fix-" --json number --jq '.[0].number')

          if [ -n "$PR_NUMBER" ]; then
            echo "Enabling auto-merge for PR #$PR_NUMBER"
            gh pr merge "$PR_NUMBER" --auto --squash --delete-branch || echo "Auto-merge not available"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-on-critical:
    runs-on: ubuntu-latest
    if: github.event_name == 'dependabot_alert'

    steps:
      - name: Check severity
        id: severity
        run: |
          # Note: dependabot_alert event includes alert details
          SEVERITY="${{ github.event.alert.security_advisory.severity }}"
          echo "severity=$SEVERITY" >> $GITHUB_OUTPUT

          if [ "$SEVERITY" == "critical" ] || [ "$SEVERITY" == "high" ]; then
            echo "is_critical=true" >> $GITHUB_OUTPUT
          else
            echo "is_critical=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue for critical vulnerabilities
        if: steps.severity.outputs.is_critical == 'true'
        run: |
          gh issue create \
            --title "ðŸš¨ Critical Security Alert: ${{ github.event.alert.security_advisory.summary }}" \
            --body "$(cat <<EOF
          ## Critical Security Vulnerability Detected

          **Package:** \`${{ github.event.alert.dependency.package.name }}\`
          **Severity:** ${{ github.event.alert.security_advisory.severity }}
          **Summary:** ${{ github.event.alert.security_advisory.summary }}

          ### Details
          - Alert: ${{ github.event.alert.html_url }}
          - CVE: ${{ github.event.alert.security_advisory.cve_id }}

          ### Action Required
          Please review and update this dependency as soon as possible.

          The Security Auto-Fix workflow should create a PR automatically.

          ---
          ðŸ¤– Generated by Security Auto-Fix workflow
          EOF
          )" \
            --label "security,critical,urgent"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
