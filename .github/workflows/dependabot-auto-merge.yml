name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_run:
    workflows: ["Dependabot Lockfile Update"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-approve-and-merge:
    runs-on: ubuntu-latest
    # Only run for Dependabot PRs
    if: github.actor == 'dependabot[bot]' || (github.event_name == 'workflow_run' && github.event.workflow_run.actor.login == 'dependabot[bot]')

    steps:
      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            # Get PR number from workflow_run event
            PR_NUMBER=$(gh pr list --repo "${{ github.repository }}" --head "${{ github.event.workflow_run.head_branch }}" --json number --jq '.[0].number')
            echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for checks to complete
        if: steps.pr.outputs.number != ''
        run: |
          echo "Waiting for PR #${{ steps.pr.outputs.number }} checks..."
          # Wait up to 3 minutes for checks (excluding CodeRabbit which skips bot PRs)
          for i in {1..18}; do
            # Exclude CodeRabbit from check evaluation (it skips bot PRs)
            STATUS=$(gh pr checks ${{ steps.pr.outputs.number }} --repo "${{ github.repository }}" --json name,state --jq '
              map(select(.name != "CodeRabbit" and .state != "SKIPPED")) |
              if length == 0 then "pass"
              elif all(.state == "SUCCESS" or .state == "NEUTRAL") then "pass"
              elif any(.state == "FAILURE") then "fail"
              else "pending"
              end
            ' 2>/dev/null || echo "pending")

            if [ "$STATUS" == "pass" ]; then
              echo "All checks passed (excluding CodeRabbit)!"
              exit 0
            elif [ "$STATUS" == "fail" ]; then
              echo "Some checks failed"
              exit 1
            fi

            echo "Checks still pending, waiting... ($i/18)"
            sleep 10
          done
          echo "Timeout waiting for checks"
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-approve PR
        if: steps.pr.outputs.number != ''
        run: |
          gh pr review ${{ steps.pr.outputs.number }} --repo "${{ github.repository }}" --approve --body "Auto-approved by Dependabot Auto-Merge workflow"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge
        if: steps.pr.outputs.number != ''
        run: |
          gh pr merge ${{ steps.pr.outputs.number }} --repo "${{ github.repository }}" --auto --squash --delete-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  retry-on-failure:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure'

    steps:
      - name: Get PR number
        id: pr
        run: |
          PR_NUMBER=$(gh pr list --repo "${{ github.repository }}" --head "${{ github.event.workflow_run.head_branch }}" --json number --jq '.[0].number')
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment to retry
        if: steps.pr.outputs.number != ''
        run: |
          # Check if we already commented to avoid spam
          EXISTING=$(gh pr view ${{ steps.pr.outputs.number }} --repo "${{ github.repository }}" --json comments --jq '.comments | map(select(.body | contains("@dependabot rebase"))) | length')

          if [ "$EXISTING" -eq "0" ]; then
            gh pr comment ${{ steps.pr.outputs.number }} --repo "${{ github.repository }}" --body "@dependabot rebase"
            echo "Requested Dependabot to rebase PR #${{ steps.pr.outputs.number }}"
          else
            echo "Already requested rebase, skipping"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
